{% extends 'her/dashboard/base_dashboard.html' %}
{% load static %}

{% block content %}
<style>
  .param-card { background:#fff; padding:.5rem; border-radius:6px; box-shadow:0 1px 2px rgba(0,0,0,0.04); margin-bottom:.5rem }
  .muted { color:#666; font-size:.9rem }
  #plot { width:100%; max-width:720px; height:460px; background:#fff; border:1px solid #e6e6e6 }
  #thetaThumb, #tafelThumb { width:100%; max-width:360px; height:240px; background:#fff; border:1px solid #e6e6e6 }
</style>

<div class="container mt-3">
  <div class="card p-3">
    <h3>TheHER — HER Analysis</h3>
    <p class="small text-muted">Upload LSV/LSV-like data, set columns and experimental parameters, then run fits.</p>

    <div class="row mt-3">
      <div class="col-lg-5">
        <form id="fitForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label">Data file</label>
            <input name="datafile" class="form-control" type="file" accept=".txt,.csv" required />
          </div>

          <div class="row g-2">
            <div class="col-6"><label class="form-label">Current col (1-based)</label><input name="current_col" class="form-control" type="number" min="1" value="1" required /></div>
            <div class="col-6"><label class="form-label">Potential col (1-based)</label><input name="potential_col" class="form-control" type="number" min="1" value="2" required /></div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-6"><label class="form-label">Delimiter</label><select name="delimiter" class="form-select"><option value="auto">Auto</option><option value=",">Comma</option><option value="\t">Tab</option><option value=";">Semicolon</option><option value=" ">Space</option></select></div>
            <div class="col-md-6"><label class="form-label">Temperature (K)</label><input name="temperature" class="form-control" type="number" step="0.1" value="298.15" /></div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-6"><label class="form-label">Electrode area (cm²)</label><input name="area_electrode" class="form-control" type="number" step="0.0001" value="0.5" required /></div>
            <div class="col-md-6"><label class="form-label">Ohmic drop (Ohm·cm²)</label><input name="ohmic_drop" class="form-control" type="number" step="0.01" value="6.43" required /></div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-6"><label class="form-label">pH</label><input name="pH" class="form-control" type="number" step="0.1" value="7.0" /></div>
            <div class="col-md-6"><label class="form-label">Model</label><select name="model_type" class="form-select"><option value="simplified">Simplified (Volmer–Heyrovsky)</option><option value="full">Full (Volmer–Heyrovsky–Tafel)</option></select></div>
          </div>

          <div class="mt-3">
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedParams">Advanced parameters</button>
          </div>

          <div class="collapse mt-3" id="advancedParams">
            <div class="card card-body">
              <div class="row g-2">
                <div class="col-md-6"><label class="form-label">Initial bbv</label><input name="bbv" class="form-control" type="number" step="0.01" value="0.5" /></div>
                <div class="col-md-6"><label class="form-label">Initial bbh</label><input name="bbh" class="form-control" type="number" step="0.01" value="0.5" /></div>
              </div>
              <div class="form-check form-switch mt-2"><input name="vary_bbv" class="form-check-input" type="checkbox" checked><label class="form-check-label">vary_bbv</label></div>
              <div class="form-check form-switch mt-2"><input name="vary_bbh" class="form-check-input" type="checkbox" checked><label class="form-check-label">vary_bbh</label></div>
              <div class="mt-2"><label class="form-label">Fitting method</label><select name="fitting_method" class="form-select"><option value="powell">powell</option><option value="nelder">nelder</option></select></div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-primary btn-sm">Run Fit & Plot</button>
            <button type="button" id="openSummary" class="btn btn-outline-secondary">Open Summary</button>
            <button type="button" id="downloadJson" class="btn btn-outline-secondary">Download JSON</button>
          </div>
        </form>
      </div>

      <div class="col-lg-7">
        <div class="mb-3">
          <img id="plot" src="" alt="fit plot" class="img-fluid" />
        </div>
        <div class="mb-2">
          <div id="stats" class="small"></div>
          <div id="params" class="mt-2"></div>
          <pre id="output" class="mt-2"></pre>
        </div>
        <div class="d-flex gap-2 mt-3">
          <img id="thetaThumb" src="" alt="theta" class="img-fluid" style="max-width:220px;" />
          <img id="tafelThumb" src="" alt="tafel" class="img-fluid" style="max-width:220px;" />
        </div>
      </div>
    </div>

    <hr class="mt-4" />
    <div class="small text-muted">
      <strong>References</strong>
      <ul>
        <li>Lasia, Andrzej. Mechanism and Kinetics of the Hydrogen Evolution Reaction. Int J Hydrogen Energy (2019).</li>
        <li>van der Heijden et al., Tafel Slope Plot as a Tool to Analyze Electrocatalytic Reactions. ACS Energy Lett (2024).</li>
      </ul>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
;(function(){
  const form = document.getElementById('fitForm')
  const out = document.getElementById('output')
  const img = document.getElementById('plot')
  const summaryBtn = document.getElementById('openSummary')
  const downloadBtn = document.getElementById('downloadJson')
  const statsDiv = document.getElementById('stats')
  const paramsDiv = document.getElementById('params')
  const thetaThumb = document.getElementById('thetaThumb')
  const tafelThumb = document.getElementById('tafelThumb')

  form.addEventListener('submit', async (e) => {
    e.preventDefault()
    out.textContent = 'Running fit...'
    statsDiv.innerHTML = ''
    paramsDiv.innerHTML = ''
    img.src = ''
    thetaThumb.src = ''
    tafelThumb.src = ''
    try {
      const fd = new FormData(form)
      const fitRes = await fetch('/fit', { method: 'POST', body: fd })
      const fitJson = await fitRes.json()
      out.textContent = JSON.stringify(fitJson, null, 2)
      if (!fitJson.success) { statsDiv.textContent = 'Fit failed: '+(fitJson.error||''); return }
      const s = fitJson.stats || {}
      statsDiv.innerHTML = `<div>χ²: ${s.chisqr||''} • redχ: ${s.redchi||''}</div>`
      const p = fitJson.parameters||{}
      for (const k of Object.keys(p)) { const d=document.createElement('div'); d.className='param-card'; d.innerHTML=`<strong>${k}</strong><div class='muted'>${p[k]}</div>`; paramsDiv.appendChild(d) }
      const plotRes = await fetch('/plot', { method: 'POST', body: fd })
      if (plotRes.ok) img.src = URL.createObjectURL(await plotRes.blob())
      const thetaRes = await fetch('/plot_theta', { method: 'POST', body: fd })
      if (thetaRes.ok) thetaThumb.src = URL.createObjectURL(await thetaRes.blob())
      const tafelRes = await fetch('/plot_tafel', { method: 'POST', body: fd })
      if (tafelRes.ok) tafelThumb.src = URL.createObjectURL(await tafelRes.blob())
      summaryBtn.onclick = ()=> window.open('/fit_summary','_blank')
      downloadBtn.onclick = ()=> { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(fitJson,null,2)],{type:'application/json'})); a.download='fit_results.json'; a.click() }
    } catch(err){ out.textContent = 'Error: '+(err.message||err) }
  })
})()
</script>

{% endblock %}
{% extends 'her/dashboard/base_dashboard.html' %}
{% load static %}

{% block content %}
<style>
  /* Inline page styles carried from legacy template */
  #fitForm { max-width: 100%; }
  #plot { width: 100%; max-width: 520px; height: 360px; object-fit: contain; background: #fff; border: 1px solid #e6e6e6; }
  #thetaThumb, #tafelThumb { width: 100%; max-width: 340px; height: 240px; object-fit: contain; background:#fff; border:1px solid #e6e6e6; cursor: pointer; transition: transform 0.2s; }
  #thetaThumb:hover, #tafelThumb:hover { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
  .param-card { background: #fff; padding: .6rem; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
  .muted { color: #666; font-size: .9rem; }
  .plot-section { margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; }
</style>

<div class="card main-card p-3">
  <h5 class="card-title">Data & Parameters</h5>
  <div class="row">
    <div class="col-md-5">
      <form id="fitForm">
        <div class="mb-2">
          <label class="form-label">Model</label>
          <select name="model_type" class="form-select">
            <option value="simplified">Simplified (Volmer–Heyrovsky)</option>
            <option value="full">full</option>
          </select>
        </div>

        <div class="row g-2">
          <div class="col-6"><label class="form-label">Initial bbv</label><input name="bbv" class="form-control" type="number" step="0.01" value="0.5" /></div>
          <div class="col-6"><label class="form-label">Initial bbh</label><input name="bbh" class="form-control" type="number" step="0.01" value="0.5" /></div>
        </div>

        <div class="mb-2"><label class="form-label">Ref potential (V)</label><input name="ref_potential" class="form-control" type="number" step="0.001" /></div>
        <div class="mb-2"><label class="form-label">pH</label><input name="pH" class="form-control" type="number" step="0.1" /></div>

        <div class="mb-2"><label class="form-label">Ohmic drop (Ω·cm²)</label><input name="ohmic_drop" class="form-control" type="text" required /></div>
        <div class="mb-2"><label class="form-label">Electrode area (cm²)</label><input name="area_electrode" class="form-control" type="text" required /></div>

        <div class="row g-2">
          <div class="col-6"><label class="form-label">Current col (1-based)</label><input name="current_col" class="form-control" type="number" min="1" value="1" required /></div>
          <div class="col-6"><label class="form-label">Potential col (1-based)</label><input name="potential_col" class="form-control" type="number" min="1" value="2" required /></div>
        </div>

        <div class="mb-2"><label class="form-label">Upload data file</label><input name="datafile" class="form-control" type="file" accept=".txt,.csv" required /></div>

        <div class="mb-2"><label class="form-label">Delimiter</label>
          <select name="delimiter" class="form-select">
            <option value="auto">Auto-detect</option>
            <option value=",">Comma (,)</option>
            <option value="\t">Tab (\t)</option>
            <option value=";">Semicolon (;)</option>
            <option value=" ">Space</option>
          </select>
        </div>

        
        <style>
          /* Minimal page styles */
          #plot { width: 100%; max-width: 640px; height: 420px; background: #fff; border: 1px solid #e6e6e6; }
          #thetaThumb, #tafelThumb { width: 100%; max-width: 360px; height: 240px; background:#fff; border:1px solid #e6e6e6; cursor: pointer; }
          .param-card { background: #fff; padding: .5rem; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); margin-bottom:.5rem }
          .muted { color: #666; font-size: .9rem; }
        </style>

        <div class="card p-3">
          <h3>TheHER — HER Analysis</h3>
          <p class="small text-muted">Upload LSV/LSV-like data, configure columns and experimental parameters, then run fits.</p>

          <form id="fitForm" enctype="multipart/form-data">
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">Data file</label>
                <input name="datafile" class="form-control" type="file" accept=".txt,.csv" required />
              </div>
              <div class="col-md-2">
                <label class="form-label">Current col (1-based)</label>
                <input name="current_col" class="form-control" type="number" min="1" value="1" required />
              </div>
              <div class="col-md-2">
                <label class="form-label">Potential col (1-based)</label>
                <input name="potential_col" class="form-control" type="number" min="1" value="2" required />
              </div>
              <div class="col-md-2">
                <label class="form-label">Delimiter</label>
                <select name="delimiter" class="form-select"><option value="auto">Auto</option><option value=",">Comma</option><option value="\t">Tab</option><option value=";">Semicolon</option><option value=" ">Space</option></select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Temperature (K)</label>
                <input name="temperature" class="form-control" type="number" step="0.1" value="298.15" />
              </div>
            </div>

            <div class="row g-2 mt-3">
              <div class="col-md-3"><label class="form-label">Electrode area (cm²)</label><input name="area_electrode" class="form-control" type="number" step="0.0001" value="0.5" required /></div>
              <div class="col-md-3"><label class="form-label">Ohmic drop (Ω)</label><input name="ohmic_drop" class="form-control" type="number" step="0.01" value="6.43" required /></div>
              <div class="col-md-2"><label class="form-label">pH</label><input name="pH" class="form-control" type="number" step="0.1" value="7.0" /></div>
              <div class="col-md-4"><label class="form-label">Model</label><select name="model_type" class="form-select"><option value="simplified">Simplified (Volmer–Heyrovsky)</option><option value="full">Full (Volmer–Heyrovsky–Tafel)</option></select></div>
            </div>

            <div class="row g-2 mt-3">
              <div class="col-md-3"><label class="form-label">Initial bbv</label><input name="bbv" class="form-control" type="number" step="0.01" value="0.5" /></div>
              <div class="col-md-3"><label class="form-label">Initial bbh</label><input name="bbh" class="form-control" type="number" step="0.01" value="0.5" /></div>
              <div class="col-md-3 d-flex align-items-end"><div class="form-check form-switch"><input name="vary_bbv" class="form-check-input" type="checkbox" checked><label class="form-check-label">vary_bbv</label></div></div>
              <div class="col-md-3 d-flex align-items-end"><div class="form-check form-switch"><input name="vary_bbh" class="form-check-input" type="checkbox" checked><label class="form-check-label">vary_bbh</label></div></div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <button type="submit" class="btn btn-primary btn-sm">Run Fit & Plot</button>
              <button type="button" id="openSummary" class="btn btn-outline-secondary">Open Summary</button>
              <button type="button" id="downloadJson" class="btn btn-outline-secondary">Download JSON</button>
            {% extends 'her/dashboard/base_dashboard.html' %}
            {% load static %}

            {% block content %}
            <style>
              .param-card { background: #fff; padding: .5rem; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); margin-bottom:.5rem }
              .muted { color: #666; font-size: .9rem; }
              #plot { width: 100%; max-width: 720px; height: 460px; background:#fff; border:1px solid #e6e6e6 }
              #thetaThumb, #tafelThumb { width:100%; max-width:360px; height:240px; background:#fff; border:1px solid #e6e6e6 }
            </style>

            <div class="container mt-3">
              <div class="card p-3">
                <h3>TheHER — HER Analysis</h3>
                <p class="small text-muted">Upload LSV/LSV-like data, configure columns and experimental parameters, then run fits.</p>

                <div class="row mt-3">
                  <div class="col-lg-5">
                    <form id="fitForm" enctype="multipart/form-data">
                      <div class="mb-3">
                        <label class="form-label">Data file</label>
                        <input name="datafile" class="form-control" type="file" accept=".txt,.csv" required />
                      </div>

                      <div class="row g-2">
                        <div class="col-6"><label class="form-label">Current col (1-based)</label><input name="current_col" class="form-control" type="number" min="1" value="1" required /></div>
                        <div class="col-6"><label class="form-label">Potential col (1-based)</label><input name="potential_col" class="form-control" type="number" min="1" value="2" required /></div>
                      </div>

                      <div class="row g-2 mt-2">
                        <div class="col-md-6"><label class="form-label">Delimiter</label><select name="delimiter" class="form-select"><option value="auto">Auto</option><option value=",">Comma</option><option value="\t">Tab</option><option value=";">Semicolon</option><option value=" ">Space</option></select></div>
                        <div class="col-md-6"><label class="form-label">Temperature (K)</label><input name="temperature" class="form-control" type="number" step="0.1" value="298.15" /></div>
                      </div>

                      <div class="row g-2 mt-2">
                        <div class="col-md-6"><label class="form-label">Electrode area (cm²)</label><input name="area_electrode" class="form-control" type="number" step="0.0001" value="0.5" required /></div>
                        <div class="col-md-6"><label class="form-label">Ohmic drop (Ω·cm²)</label><input name="ohmic_drop" class="form-control" type="number" step="0.01" value="6.43" required /></div>
                      </div>

                      <div class="row g-2 mt-2">
                        <div class="col-md-6"><label class="form-label">pH</label><input name="pH" class="form-control" type="number" step="0.1" value="7.0" /></div>
                        <div class="col-md-6"><label class="form-label">Model</label><select name="model_type" class="form-select"><option value="simplified">simplified</option><option value="full">full</option></select></div>
                      </div>

                      <div class="mt-3">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedParams">Advanced parameters</button>
                      </div>

                      <div class="collapse mt-3" id="advancedParams">
                        <div class="card card-body">
                          <div class="row g-2">
                            <div class="col-md-6"><label class="form-label">Initial bbv</label><input name="bbv" class="form-control" type="number" step="0.01" value="0.5" /></div>
                            <div class="col-md-6"><label class="form-label">Initial bbh</label><input name="bbh" class="form-control" type="number" step="0.01" value="0.5" /></div>
                          </div>
                          <div class="form-check form-switch mt-2"><input name="vary_bbv" class="form-check-input" type="checkbox" checked><label class="form-check-label">vary_bbv</label></div>
                          <div class="form-check form-switch mt-2"><input name="vary_bbh" class="form-check-input" type="checkbox" checked><label class="form-check-label">vary_bbh</label></div>
                          <div class="mt-2"><label class="form-label">Fitting method</label><select name="fitting_method" class="form-select"><option value="powell">powell</option><option value="nelder">nelder</option></select></div>
                        </div>
                      </div>

                      <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-primary btn-sm">Run Fit & Plot</button>
                        <button type="button" id="openSummary" class="btn btn-outline-secondary">Open Summary</button>
                        <button type="button" id="downloadJson" class="btn btn-outline-secondary">Download JSON</button>
                      </div>
                    </form>
                  </div>

                  <div class="col-lg-7">
                    <div class="mb-3">
                      <img id="plot" src="" alt="fit plot" class="img-fluid" />
                    </div>
                    <div class="mb-2">
                      <div id="stats" class="small"></div>
                      <div id="params" class="mt-2"></div>
                      <pre id="output" class="mt-2"></pre>
                    </div>
                    <div class="d-flex gap-2 mt-3">
                      <img id="thetaThumb" src="" alt="theta" class="img-fluid" style="max-width:220px;" />
                      <img id="tafelThumb" src="" alt="tafel" class="img-fluid" style="max-width:220px;" />
                    </div>
                  </div>
                </div>

                <hr class="mt-4" />
                <div class="small text-muted">
                  <strong>References</strong>
                  <ul>
                    <li>Lasia, Andrzej. Mechanism and Kinetics of the Hydrogen Evolution Reaction. Int J Hydrogen Energy (2019).</li>
                    <li>van der Heijden et al., Tafel Slope Plot as a Tool to Analyze Electrocatalytic Reactions. ACS Energy Lett (2024).</li>
                  </ul>
                </div>
              </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
            <script>
            ;(function(){
              const form = document.getElementById('fitForm')
              const out = document.getElementById('output')
              const img = document.getElementById('plot')
              const summaryBtn = document.getElementById('openSummary')
              const downloadBtn = document.getElementById('downloadJson')
              const statsDiv = document.getElementById('stats')
              const paramsDiv = document.getElementById('params')
              const thetaThumb = document.getElementById('thetaThumb')
              const tafelThumb = document.getElementById('tafelThumb')

              form.addEventListener('submit', async (e) => {
                e.preventDefault()
                out.textContent = 'Running fit...'
                statsDiv.innerHTML = ''
                paramsDiv.innerHTML = ''
                img.src = ''
                thetaThumb.src = ''
                tafelThumb.src = ''
                try {
                  const fd = new FormData(form)
                  const fitRes = await fetch('/fit', { method: 'POST', body: fd })
                  const fitJson = await fitRes.json()
                  out.textContent = JSON.stringify(fitJson, null, 2)
                  if (!fitJson.success) { statsDiv.textContent = 'Fit failed: '+(fitJson.error||''); return }
                  const s = fitJson.stats || {}
                  statsDiv.innerHTML = `<div>χ²: ${s.chisqr||''} • redχ: ${s.redchi||''}</div>`
                  const p = fitJson.parameters||{}
                  for (const k of Object.keys(p)) { const d=document.createElement('div'); d.className='param-card'; d.innerHTML=`<strong>${k}</strong><div class='muted'>${p[k]}</div>`; paramsDiv.appendChild(d) }
                  const plotRes = await fetch('/plot', { method: 'POST', body: fd })
                  if (plotRes.ok) img.src = URL.createObjectURL(await plotRes.blob())
                  const thetaRes = await fetch('/plot_theta', { method: 'POST', body: fd })
                  if (thetaRes.ok) thetaThumb.src = URL.createObjectURL(await thetaRes.blob())
                  const tafelRes = await fetch('/plot_tafel', { method: 'POST', body: fd })
                  if (tafelRes.ok) tafelThumb.src = URL.createObjectURL(await tafelRes.blob())
                  summaryBtn.onclick = ()=> window.open('/fit_summary','_blank')
                  downloadBtn.onclick = ()=> { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(fitJson,null,2)],{type:'application/json'})); a.download='fit_results.json'; a.click() }
                } catch(err){ out.textContent = 'Error: '+(err.message||err) }
              })
            })()
            </script>

            {% endblock %}

