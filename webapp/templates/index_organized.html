{% extends 'her/dashboard/base_dashboard.html' %}
{% load static %}

{% block content %}
<style>
  .param-card { background:#fff; padding:.5rem; border-radius:6px; box-shadow:0 1px 2px rgba(0,0,0,0.04); margin-bottom:.5rem }
  .muted { color:#666; font-size:.9rem }
  #plot, #thetaThumb, #tafelThumb { width:100%; max-width:100%; height:auto; max-height:640px; background:#fff; border:1px solid #e6e6e6; display:block }
  img.img-fluid { object-fit:contain; }
</style>

<div class="container-fluid px-4">
  <div class="card p-3 shadow-sm">
    <h4 class="mb-2">Analysis Workspace</h4>
    <p class="small text-muted mb-3">Upload LSV data, configure parameters, and run fitting analysis</p>

    <div class="row g-3">
      <div class="col-lg-5">
        <form id="fitForm" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Data file</label>
            <input name="datafile" class="form-control" type="file" accept=".txt,.csv" required />
          </div>

          <div class="row g-2">
            <div class="col-6"><label class="form-label">Current col (1-based)</label><input name="current_col" class="form-control" type="number" min="1" value="1" required /></div>
            <div class="col-6"><label class="form-label">Potential col (1-based)</label><input name="potential_col" class="form-control" type="number" min="1" value="2" required /></div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-6"><label class="form-label">Delimiter</label><select name="delimiter" class="form-select"><option value="auto">Auto</option><option value=",">Comma</option><option value="\t">Tab</option><option value=";">Semicolon</option><option value=" ">Space</option></select></div>
            <div class="col-md-6"><label class="form-label">Temperature (K)</label><input name="temperature" class="form-control" type="number" step="0.1" value="298.15" /></div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-6"><label class="form-label">Electrode area (cm²)</label><input name="area_electrode" class="form-control" type="number" step="0.0001" value="0.5" required /></div>
            <div class="col-md-6"><label class="form-label">Ohmic drop (Ω)</label><input name="ohmic_drop" class="form-control" type="number" step="0.01" value="6.43" required /></div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-4"><label class="form-label">pH</label><input name="pH" class="form-control" type="number" step="0.1" value="7.0" /></div>
            <div class="col-md-4"><label class="form-label">Ref potential (V)</label><input name="ref_potential" class="form-control" type="number" step="0.001" value="0.0" /></div>
            <div class="col-md-4"><label class="form-label">Model</label><select name="model_type" class="form-select"><option value="simplified">Simplified (Volmer–Heyrovsky)</option><option value="full">Full (Volmer–Heyrovsky–Tafel)</option></select></div>
          </div>

          <div class="mt-3">
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedParams">Advanced parameters</button>
          </div>

          <div class="collapse mt-3" id="advancedParams">
            <div class="card card-body">
              <div class="mb-2"><small class="text-muted">Set initial, bounds and whether the parameter should vary during fit.</small></div>
              <!-- reference potential moved out of advanced parameters -->
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Parameter</th>
                      <th>Initial</th>
                      <th>Min</th>
                      <th>Max</th>
                      <th>Vary</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="param-row" data-models="simplified,full">
                      <td>k1</td>
                      <td><input name="k1_init" placeholder="Default" class="form-control form-control-sm" type="number" step="any" /></td>
                      <td><input name="k1_min" class="form-control form-control-sm" type="number" step="any" value="1e-20"/></td>
                      <td><input name="k1_max" class="form-control form-control-sm" type="number" step="any" value="1e-2"/></td>
                      <td><select name="vary_k1" class="form-select form-select-sm"><option value="true" selected>true</option><option value="false">false</option></select></td>
                    </tr>

                    <tr class="param-row" data-models="simplified,full">
                      <td>k1r</td>
                      <td><input name="k1r_init" placeholder="Default" class="form-control form-control-sm" type="number" step="any" /></td>
                      <td><input name="k1r_min" class="form-control form-control-sm" type="number" step="any" value="1e-20"/></td>
                      <td><input name="k1r_max" class="form-control form-control-sm" type="number" step="any" value="1e-2"/></td>
                      <td><select name="vary_k1r" class="form-select form-select-sm"><option value="true" selected>true</option><option value="false">false</option></select></td>
                    </tr>

                    <tr class="param-row" data-models="simplified,full">
                      <td>k2</td>
                      <td><input name="k2_init" placeholder="Default" class="form-control form-control-sm" type="number" step="any" /></td>
                      <td><input name="k2_min" class="form-control form-control-sm" type="number" step="any" value="1e-20"/></td>
                      <td><input name="k2_max" class="form-control form-control-sm" type="number" step="any" value="1e-2"/></td>
                      <td><select name="vary_k2" class="form-select form-select-sm"><option value="true" selected>true</option><option value="false">false</option></select></td>
                    </tr>

                    <tr class="param-row" data-models="simplified">
                      <td>k2r</td>
                      <td><input name="k2r_init" placeholder="Default" class="form-control form-control-sm" type="number" step="any" /></td>
                      <td><input name="k2r_min" class="form-control form-control-sm" type="number" step="any" value="1e-20"/></td>
                      <td><input name="k2r_max" class="form-control form-control-sm" type="number" step="any" value="1e-2"/></td>
                      <td><select name="vary_k2r" class="form-select form-select-sm"><option value="true" selected>true</option><option value="false">false</option></select></td>
                    </tr>

                    <tr class="param-row" data-models="full">
                      <td>k3</td>
                      <td><input name="k3_init" placeholder="Default" class="form-control form-control-sm" type="number" step="any" /></td>
                      <td><input name="k3_min" class="form-control form-control-sm" type="number" step="any" value="1e-20"/></td>
                      <td><input name="k3_max" class="form-control form-control-sm" type="number" step="any" value="1e-2"/></td>
                      <td><select name="vary_k3" class="form-select form-select-sm"><option value="true" selected>true</option><option value="false">false</option></select></td>
                    </tr>

                    <tr class="param-row" data-models="simplified,full">
                      <td>bbv</td>
                      <td><input name="bbv" class="form-control form-control-sm" type="number" step="0.01" value="0.5" /></td>
                      <td><input name="bbv_min" class="form-control form-control-sm" type="number" step="0.01" value="0.0"/></td>
                      <td><input name="bbv_max" class="form-control form-control-sm" type="number" step="0.01" value="1.0"/></td>
                      <td><select name="vary_bbv" class="form-select form-select-sm"><option value="true" selected>true</option><option value="false">false</option></select></td>
                    </tr>

                    <tr class="param-row" data-models="simplified,full">
                      <td>bbh</td>
                      <td><input name="bbh" class="form-control form-control-sm" type="number" step="0.01" value="0.5" /></td>
                      <td><input name="bbh_min" class="form-control form-control-sm" type="number" step="0.01" value="0.0"/></td>
                      <td><input name="bbh_max" class="form-control form-control-sm" type="number" step="0.01" value="1.0"/></td>
                      <td><select name="vary_bbh" class="form-select form-select-sm"><option value="true" selected>true</option><option value="false">false</option></select></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="mt-2"><label class="form-label">Fitting method</label><select name="fitting_method" class="form-select"><option value="powell">powell</option><option value="nelder">nelder</option></select></div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-primary btn-sm">Run Fit & Plot</button>
            <button type="button" id="openSummary" class="btn btn-outline-secondary btn-sm">Open Summary</button>
            <div class="btn-group">
              <button type="button" id="downloadParams" class="btn btn-outline-secondary btn-sm">Export Params/Stats</button>
              <select id="exportPlotSelect" class="form-select form-select-sm ms-2 me-2" style="width:170px;">
                <option value="fit">Fit Plot</option>
                <option value="theta">Theta</option>
                <option value="tafel">Tafel</option>
                <option value="all">All (zip)</option>
              </select>
              <button type="button" id="downloadGraphData" class="btn btn-outline-secondary btn-sm">Export Plot Data</button>
            </div>
          </div>
        </form>
      </div>

      <div class="col-lg-7">
        <div class="mb-3">
          <div class="card p-2 mb-2">
            <strong>Fit Plot</strong>
            <div class="mt-2">
              <img id="plot" alt="fit plot" class="img-fluid" style="display:none" />
            </div>
          </div>

          <div class="row g-2">
            <div class="col-md-6">
              <div class="card p-2 mb-2 h-100">
                <strong>Theta</strong>
                <div class="mt-2"><img id="thetaThumb" alt="theta" class="img-fluid" style="display:none" /></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card p-2 mb-2 h-100">
                <strong>Tafel</strong>
                <div class="mt-2"><img id="tafelThumb" alt="tafel" class="img-fluid" style="display:none" /></div>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-2">
          <div id="resultsRow" class="row">
            <div class="col-md-7">
              <div class="card p-2 mb-2">
                <div class="d-flex justify-content-between align-items-center">
                  <strong>Fitted Parameters</strong>
                </div>
                <div class="table-responsive mt-2">
                  <table id="fittedParams" class="table table-sm table-striped mb-0"><thead><tr><th>Name</th><th>Value</th></tr></thead><tbody></tbody></table>
                </div>
              </div>
            </div>
            <div class="col-md-5">
              <div class="card p-2 mb-2">
                <strong>Fit Statistics</strong>
                <div class="table-responsive mt-2">
                  <table id="fitStats" class="table table-sm mb-0"><tbody></tbody></table>
                </div>
              </div>
            </div>
          </div>
          <pre id="output" class="mt-2"></pre>
        </div>
      </div>
    </div>

    <hr class="mt-4" />
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
;(function(){
  const form = document.getElementById('fitForm')
  const out = document.getElementById('output')
  const img = document.getElementById('plot')
  const summaryBtn = document.getElementById('openSummary')
  const fittedBody = document.querySelector('#fittedParams tbody')
  const statsBody = document.querySelector('#fitStats tbody')
  const thetaThumb = document.getElementById('thetaThumb')
  const tafelThumb = document.getElementById('tafelThumb')
  const downloadParamsBtn = document.getElementById('downloadParams')
  const downloadGraphDataBtn = document.getElementById('downloadGraphData')
  const exportPlotSelect = document.getElementById('exportPlotSelect')
  const modelSelect = form.querySelector('select[name="model_type"]')

  function updateParamVisibility(){
    try{
      const m = (modelSelect && modelSelect.value) ? modelSelect.value : 'simplified'
      document.querySelectorAll('.param-row').forEach(r => {
        const models = (r.getAttribute('data-models')||'').split(',').map(s=>s.trim()).filter(Boolean)
        if(models.length === 0) { r.style.display = '' ; return }
        r.style.display = models.includes(m) ? '' : 'none'
      })
    }catch(e){ /* silent */ }
  }
  // update once and when model changes
  updateParamVisibility()
  if(modelSelect) modelSelect.addEventListener('change', updateParamVisibility)

  form.addEventListener('submit', async (e) => {
    e.preventDefault()
    out.textContent = 'Running fit...'
    if(fittedBody) fittedBody.innerHTML = ''
    if(statsBody) statsBody.innerHTML = ''
    img.style.display = 'none'
    thetaThumb.style.display = 'none'
    tafelThumb.style.display = 'none'
    try {
      const fd = new FormData(form)
      const fitRes = await fetch('/fit', { method: 'POST', body: fd })
      const fitJson = await fitRes.json()
      if (!fitJson.success) { out.textContent = 'Fit failed: '+(fitJson.error||''); return }
      out.textContent = ''
      const s = fitJson.stats || {}
      // populate stats table
      if(statsBody){
        statsBody.innerHTML = ''
        const addStat = (label, val) => { const tr=document.createElement('tr'); tr.innerHTML = `<th style="width:60%">${label}</th><td>${val!==undefined?val:''}</td>`; statsBody.appendChild(tr) }
        addStat('χ²', s.chisqr)
        addStat('Reduced χ²', s.redchi)
        addStat('AIC', s.aic)
        addStat('BIC', s.bic)
        addStat('nfree', s.nfree)
        addStat('n_points', fitJson.n_points||'')
      }
      // populate fitted parameters
      if(fittedBody){
        fittedBody.innerHTML = ''
        const p = fitJson.parameters||{}
        for(const [k,v] of Object.entries(p)){
          const tr = document.createElement('tr')
          tr.innerHTML = `<td>${k}</td><td class='muted'>${v}</td>`
          fittedBody.appendChild(tr)
        }
      }
      // attach export handlers using latest fitJson
      if(downloadParamsBtn) downloadParamsBtn.onclick = ()=> {
        // create CSV: first parameters, then a blank line, then stats
        try{
          const p = fitJson.parameters||{}
          const s = fitJson.stats||{}
          let csv = 'type,name,value\n'
          for(const [k,v] of Object.entries(p)) csv += `param,${k},${v}\n`
          csv += '\n'
          for(const [k,v] of Object.entries(s)) csv += `stat,${k},${v}\n`
          const blob = new Blob([csv], {type:'text/csv'})
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='fit_params_stats.csv'; a.click()
        }catch(err){ alert('Export failed: '+(err.message||err)) }
      }
      if(downloadGraphDataBtn) downloadGraphDataBtn.onclick = async ()=> {
        // request theta and tafel numeric data from endpoints
        try{
          const choice = exportPlotSelect ? exportPlotSelect.value : 'all'
          if(choice === 'all'){
            // request zip from server
            const fdZip = new FormData(form)
            const zipRes = await fetch('/export_plots_zip', {method:'POST', body: fdZip})
            if(!zipRes.ok) throw new Error('ZIP export failed')
            const blob = await zipRes.blob()
            const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='plots.zip'; a.click(); return
          }
          // otherwise fetch single plot JSON and convert to CSV
          if(choice === 'fit'){
            const fd = new FormData(form); fd.append('as','json')
            const res = await fetch('/plot',{method:'POST', body: fd})
            const plotData = res.ok ? await res.json() : null
            if(plotData){ let csv = 'Potential,Fitted_current\n' + plotData.x.map((v,i)=>`${v},${plotData.y[i]}`).join('\n'); const b=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='fit_plot.csv'; a.click() }
            return
          }
          if(choice === 'theta'){
            const fd = new FormData(form); fd.append('as','json')
            const res = await fetch('/plot_theta',{method:'POST', body: fd})
            const thetaData = res.ok ? await res.json() : null
            if(thetaData){ let csv = 'Potential,Hydrogen_Coverage\n' + thetaData.x.map((v,i)=>`${v},${thetaData.y[i]}`).join('\n'); const b=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='theta.csv'; a.click() }
            return
          }
          if(choice === 'tafel'){
            const fd = new FormData(form); fd.append('as','json')
            const res = await fetch('/plot_tafel',{method:'POST', body: fd})
            const tafelData = res.ok ? await res.json() : null
            if(tafelData){ let csv = 'Average_Potential,Tafel_Slope\n' + tafelData.x.map((v,i)=>`${v},${tafelData.slope[i]}`).join('\n'); const b=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='tafel.csv'; a.click() }
            return
          }
        }catch(err){ alert('Export failed: '+(err.message||err)) }
      }
      const plotRes = await fetch('/plot', { method: 'POST', body: fd })
      if (plotRes.ok) { img.src = URL.createObjectURL(await plotRes.blob()); img.style.display = 'block' }
      const thetaRes = await fetch('/plot_theta', { method: 'POST', body: fd })
      if (thetaRes.ok) { thetaThumb.src = URL.createObjectURL(await thetaRes.blob()); thetaThumb.style.display = 'block' }
      const tafelRes = await fetch('/plot_tafel', { method: 'POST', body: fd })
      if (tafelRes.ok) { tafelThumb.src = URL.createObjectURL(await tafelRes.blob()); tafelThumb.style.display = 'block' }
      summaryBtn.onclick = ()=> window.open('/fit_summary','_blank')
      // legacy raw JSON download removed; use Export buttons
    } catch(err){ out.textContent = 'Error: '+(err.message||err) }
  })
})()
</script>

{% endblock %}
